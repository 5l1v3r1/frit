#!/usr/bin/python
import sys
import os.path
import configobj
import fritutils.termout
import fritcommands.init
import fritcommands.mount
import fritcommands.status
import fritcommands.store
from fritutils import fritobjects

def mainFrit():
    verbose = False
    # Check to see if a command was given.
    if len(sys.argv) < 2:
        fritutils.termout.printWarning('No command was given')
        sys.exit(1)
    # check to see if the current working dir is allowed
    fritutils.noBadPath()
    # Separate command and the command arguemnts
    (command,args) = fritutils.getCommand(sys.argv[1:])
    # here we get the options from the args
    # we have to work on this :-)
    if args:
        if '-v' in args:
            args = args.pop('-v')
            verbose = True
    # If the command is init, just do it
    if command == 'init':
        # check to see if .frit already exists
        if not fritutils.isCwdFrit():
            fritcommands.init.initCommand()
            sys.exit(0)
        else:
            fritutils.termout.printWarning("A .frit directory already exists.")
            sys.exit(1)
    # The command is not init, so we should find a config file
    if os.path.exists('.frit/config'):
        try:
            fritConfig = configobj.ConfigObj('.frit/config')
        except configobj.ConfigObjError:
            fritutils.termout.printWarning('The config file contains errors.')
            sys.exit(1)
    # Here we try to map evidences from config file to Evidence objects
    Evidences = fritobjects.evidencesFromConfig(fritConfig, verbose=verbose)

    # user isued a mount command
    if command == 'mount':
        fritcommands.mount.fullMount(Evidences)
        sys.exit(0)
    
    if command == 'umount':
        fritcommands.mount.fullUmount(Evidences)
        sys.exit(0)
        
    if command == 'status':
        fritcommands.status.status(Evidences,args)
        sys.exit(0)
    
    if command == 'store':
        fritcommands.store.store(Evidences,args)
        sys.exit(0)
    
    # Obviously, the given command was not found
    fritutils.termout.printWarning('The "%s" command was not found.' % command)
if __name__ == '__main__':
    mainFrit()
